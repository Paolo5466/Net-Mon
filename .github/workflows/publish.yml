# This workflow will build and publish a Docker Image to GitHub Container Registry
# See https://github.com/docker/build-push-action
# CR_PAT with write:package is needed as GITHUB_TOKEN does not currently have the required permissions.
# https://docs.github.com/en/packages/guides/migrating-to-github-container-registry-for-docker-images#authenticating-with-the-container-registry
# https://docs.github.com/en/packages/guides/using-github-packages-with-github-actions#authenticating-to-github-container-registry

name: Publish Image

on:
  release:
    types: [published]
    
jobs:
  push_to_registry:
    name: Push Docker Image to GitHub Container Registry
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set version variable
      id: vars
      run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
   
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1 
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.CR_PAT }}
    
    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: ${{ runner.os }}-buildx-
    
    - name: Build and push
      id: docker_build
      uses: docker/build-push-action@v2
      with:
        push: true
        tags: |
          ghcr.io/rafhaanshah/net-mon:${{ steps.vars.outputs.tag }}
          ghcr.io/rafhaanshah/net-mon:latest

    - name: Print image digest
      run: echo ${{ steps.docker_build.outputs.digest }}
